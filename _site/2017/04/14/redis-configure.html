<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Redis 安装和配置</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="jylaxp">

<meta name="description" content="1.安装redis 环境: 系统:centos6.8" />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Redis 安装和配置">
<meta itemprop="description" content="1.安装redis 环境: 系统:centos6.8">

  <meta itemprop="image" content="http://localhost:4000">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Redis 安装和配置">
<meta name="twitter:description" content="1.安装redis 环境: 系统:centos6.8">



<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="http://localhost:4000">
  <meta property="twitter:image" content="http://localhost:4000">

<meta property="twitter:url" content="http://localhost:4000/2017/04/14/redis-configure.html">

<!-- Open Graph data -->
<meta property="og:title" content="Redis 安装和配置" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/2017/04/14/redis-configure.html" />

  <meta property="og:image" content="http://localhost:4000" />

<meta property="og:description" content="1.安装redis 环境: 系统:centos6.8" />
<meta property="og:site_name" content="jylaxp's Blog" />

  <meta property="article:published_time" content="2017-04-14T00:00:00+08:00" />














  





  




    

    <link rel="canonical" href="http://localhost:4000/2017/04/14/redis-configure.html">

    

    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">jylaxp&#39;s Blog</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
              
                <a class="page-link" href="/contact.html">Contact</a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Redis 安装和配置</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2017-04-14T00:00:00+08:00" itemprop="datePublished">
          
          Apr 14, 2017
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">jylaxp</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Redis 安装和配置</h1>
    <p class="post-meta">
      <time datetime="2017-04-14T00:00:00+08:00" itemprop="datePublished">
        
        Apr 14, 2017
      </time>
      </p>
  </header> -->

  <div itemprop="articleBody">
    <h2 id="1安装redis">1.安装redis</h2>
<h3 id="环境">环境:</h3>
<ul>
  <li>系统:centos6.8</li>
</ul>

<h3 id="准备工作">准备工作</h3>
<p>由于采用源码编译安装redis，所以在编译之前先做一些准备工作</p>
<ul>
  <li>redis源码是c语言，所以编译redis需要gcc
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install <span class="nt">-y</span> gcc
<span class="c"># 或者安装开发工具包</span>
yum groupinstall <span class="nt">-y</span> <span class="s2">"Development Tools"</span>
</code></pre></div>    </div>
  </li>
  <li>下载redis源码并加压
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://download.redis.io/redis-stable.tar.gz
<span class="nb">tar </span>zxvf redis-stable.tar.gz
<span class="nb">cd </span>redis-stable
</code></pre></div>    </div>
    <h3 id="编译安装">编译安装</h3>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
make <span class="nb">test
</span>make install
</code></pre></div>    </div>
    <h3 id="遇到的问题">遇到的问题</h3>
  </li>
  <li>执行make的时候报下面的错
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zmalloc.h:51:31: error: jemalloc/jemalloc.h: No such file or directory
</code></pre></div>    </div>
    <p>解决办法：</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make MALLOC=libc
</code></pre></div>    </div>
    <p>或</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make distclean
</code></pre></div>    </div>
    <p>然后再make</p>
  </li>
  <li>make成功以后，需要make test。在make test出现异常
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>couldn<span class="s1">'t execute "tclsh8.5": no such file or directory
</span></code></pre></div>    </div>
    <p>解决办法</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install <span class="nt">-y</span> tcl
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="2-启动和停止redis">2. 启动和停止Redis</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center">命令</th>
      <th style="text-align: center">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">redis-server</td>
      <td style="text-align: center">redis服务</td>
    </tr>
    <tr>
      <td style="text-align: center">redis-cli</td>
      <td style="text-align: center">redis命令行客户端</td>
    </tr>
    <tr>
      <td style="text-align: center">redis-benchmark</td>
      <td style="text-align: center">redis性能测试工具</td>
    </tr>
    <tr>
      <td style="text-align: center">redis-check-aof</td>
      <td style="text-align: center">aof文件修复工具</td>
    </tr>
    <tr>
      <td style="text-align: center">redis-check-rdb</td>
      <td style="text-align: center">rdb文件修复工具</td>
    </tr>
    <tr>
      <td style="text-align: center">redis-sentinel</td>
      <td style="text-align: center">sentinel服务器</td>
    </tr>
  </tbody>
</table>

<h3 id="21-直接启动">2.1 直接启动</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis-server
</code></pre></div></div>
<p>终端里输出一下内容：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2142:C 04 Apr 19:35:23.300 <span class="c"># Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span>
2142:M 04 Apr 19:35:23.303 <span class="k">*</span> Increased maximum number of open files to 10032 <span class="o">(</span>it was originally <span class="nb">set </span>to 1024<span class="o">)</span><span class="nb">.</span>
                _._
           _.-<span class="sb">``</span>__ <span class="s1">''</span>-._
      _.-<span class="sb">``</span>    <span class="sb">`</span><span class="nb">.</span>  <span class="sb">`</span>_.  <span class="s1">''</span>-._           Redis 3.2.8 <span class="o">(</span>00000000/0<span class="o">)</span> 64 bit
  .-<span class="sb">``</span> .-<span class="sb">```</span><span class="nb">.</span>  <span class="sb">```</span><span class="se">\/</span>    _.,_ <span class="s1">''</span>-._
 <span class="o">(</span>    <span class="s1">'      ,       .-`  | `,    )     Running in standalone mode
 |`-._`-...-` __...-.``-._|'</span><span class="sb">`</span> _.-<span class="s1">'|     Port: 6379
 |    `-._   `._    /     _.-'</span>    |     PID: 2142
  <span class="sb">`</span>-._    <span class="sb">`</span>-._  <span class="sb">`</span>-./  _.-<span class="s1">'    _.-'</span>
 |<span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>_.-<span class="s1">'|
 |    `-._`-._        _.-'</span>_.-<span class="s1">'    |           http://redis.io
  `-._    `-._`-.__.-'</span>_.-<span class="s1">'    _.-'</span>
 |<span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>_.-<span class="s1">'|
 |    `-._`-._        _.-'</span>_.-<span class="s1">'    |
  `-._    `-._`-.__.-'</span>_.-<span class="s1">'    _.-'</span>
      <span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>
          <span class="sb">`</span>-._        _.-<span class="s1">'
              `-.__.-'</span>

2142:M 04 Apr 19:35:23.322 <span class="c"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
2142:M 04 Apr 19:35:23.322 <span class="c"># Server started, Redis version 3.2.8</span>
2142:M 04 Apr 19:35:23.323 <span class="c"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
2142:M 04 Apr 19:35:23.323 <span class="c"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span>
2142:M 04 Apr 19:35:23.323 <span class="k">*</span> DB loaded from disk: 0.000 seconds
2142:M 04 Apr 19:35:23.323 <span class="k">*</span> The server is now ready to accept connections on port 6379

</code></pre></div></div>

<p>输出中有四个警告，现在来解决这四个警告</p>
<ul>
  <li>第一个警告
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
</code></pre></div>    </div>
  </li>
  <li>第二个警告
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is <span class="nb">set </span>to the lower value of 128.
</code></pre></div>    </div>
    <p>临时修改，本次会话有效</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>511 <span class="o">&gt;</span> /proc/sys/net/core/somaxconn
</code></pre></div>    </div>
    <p>修改配置文件/etc/sysctl.conf, 重启后生效</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/sysctl.conf
</code></pre></div>    </div>
    <p>在末尾追加</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net.core.somaxconn <span class="o">=</span> 512
</code></pre></div>    </div>
    <p>保存后重启</p>
  </li>
  <li>第三个警告
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>overcommit_memory is <span class="nb">set </span>to 0! Background save may fail under low memory condition. To fix this issue add <span class="s1">'vm.overcommit_memory = 1'</span> to /etc/sysctl.conf and <span class="k">then </span>reboot or run the <span class="nb">command</span> <span class="s1">'sysctl vm.overcommit_memory=1'</span> <span class="k">for </span>this to take effect
</code></pre></div>    </div>
    <p>这个警告中说的已经很清楚了
修改配置文件 /etc/sysctl.conf， 在文件加入vm.overcommit_memory = 1 重启生效；<br />
命令行中输入一下命令，本次会话有效</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysctl vm.overcommit_memory<span class="o">=</span>1
</code></pre></div>    </div>
  </li>
  <li>第四个警告
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>you have Transparent Huge Pages <span class="o">(</span>THP<span class="o">)</span> support enabled <span class="k">in </span>your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the <span class="nb">command</span> <span class="s1">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> as root, and add it to your /etc/rc.local <span class="k">in </span>order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
</code></pre></div>    </div>
    <p>命令行中输入一下命令，本次会话有效</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>never <span class="o">&gt;</span> /sys/kernel/mm/transparent_hugepage/enabled
</code></pre></div>    </div>
    <p>将上述命令加入到/etc/rc.local 文件， 重启后生效</p>
  </li>
</ul>

<h3 id="22-通过初始化脚本启动redis">2.2 通过初始化脚本启动Redis</h3>
<p>在Redis源代码目录的utils文件夹中有一个名为redis_init_script的初始化脚本文件,内容如下：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># Simple Redis init.d script conceived to work on Linux systems</span>
<span class="c"># as it does use of the /proc filesystem.</span>

<span class="nv">REDISPORT</span><span class="o">=</span>6379
<span class="nv">EXEC</span><span class="o">=</span>/usr/local/bin/redis-server
<span class="nv">CLIEXEC</span><span class="o">=</span>/usr/local/bin/redis-cli

<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/redis_<span class="k">${</span><span class="nv">REDISPORT</span><span class="k">}</span>.pid
<span class="nv">CONF</span><span class="o">=</span><span class="s2">"/etc/redis/</span><span class="k">${</span><span class="nv">REDISPORT</span><span class="k">}</span><span class="s2">.conf"</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
    </span>start<span class="p">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$PIDFILE</span> <span class="o">]</span>
        <span class="k">then
                </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2"> exists, process is already running or crashed"</span>
        <span class="k">else
                </span><span class="nb">echo</span> <span class="s2">"Starting Redis server..."</span>
                <span class="nv">$EXEC</span> <span class="nv">$CONF</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
    stop<span class="p">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$PIDFILE</span> <span class="o">]</span>
        <span class="k">then
                </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2"> does not exist, process is not running"</span>
        <span class="k">else
                </span><span class="nv">PID</span><span class="o">=</span><span class="k">$(</span><span class="nb">cat</span> <span class="nv">$PIDFILE</span><span class="k">)</span>
                <span class="nb">echo</span> <span class="s2">"Stopping ..."</span>
                <span class="nv">$CLIEXEC</span> <span class="nt">-p</span> <span class="nv">$REDISPORT</span> shutdown
                <span class="k">while</span> <span class="o">[</span> <span class="nt">-x</span> /proc/<span class="k">${</span><span class="nv">PID</span><span class="k">}</span> <span class="o">]</span>
                <span class="k">do
                    </span><span class="nb">echo</span> <span class="s2">"Waiting for Redis to shutdown ..."</span>
                    sleep 1
                <span class="k">done
                </span><span class="nb">echo</span> <span class="s2">"Redis stopped"</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Please use start or stop as first argument"</span>
        <span class="p">;;</span>
<span class="k">esac</span>

</code></pre></div></div>

<p>为了让脚本正常工作，需要做一些配置</p>
<ul>
  <li>redis配置文件 <br />
  上述脚本中有这一行代码
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CONF</span><span class="o">=</span><span class="s2">"/etc/redis/</span><span class="k">${</span><span class="nv">REDISPORT</span><span class="k">}</span><span class="s2">.conf"</span>
</code></pre></div>    </div>
    <p>这个脚本启动的时候回读取 /etc/redis/6379.conf 这个配置文件。在redis的源码中有一个 redis.conf 的模板配置文件，
我就以这个配置文件为模板来进行配置。</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /etc/redis
cp redis.conf /etc/redis/6379.conf
</code></pre></div>    </div>
    <p>这一步已经完成，redis.conf 配置文件的具体配置项，后面有详细的配置。</p>
  </li>
  <li>开机启动
  将上述脚本文件copy到 /etc/init.d目录中
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp redis_init_script /etc/init.d/redis
</code></pre></div>    </div>
    <p>在 /etc/init.d/redis 脚本靠前的位置加入</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chkconfig:   2345 90 10</span>
<span class="c"># description:  Redis is a persistent key-value database</span>
</code></pre></div>    </div>
    <p>设置开机启动</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chkconfig redis on
</code></pre></div>    </div>
    <p>修改redis启动方式， 修改配置文件/etc/redis/6379.conf的daemonize项，改为yes</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">################################# GENERAL #####################################</span>

<span class="c"># By default Redis does not run as a daemon. Use 'yes' if you need it.</span>
<span class="c"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span>
daemonize yes
</code></pre></div></div>
<p>至此，脚本开启启动配置完成。</p>

<h2 id="3-复制">3. 复制</h2>
<h3 id="31-环境">3.1 环境:</h3>
<p>准备三台机器，ip地址如下:</p>
<ul>
  <li>node1: 192.168.10.10</li>
  <li>node2: 192.168.10.11</li>
  <li>node3: 192.168.10.12</li>
</ul>

<h3 id="32-配置">3.2 配置</h3>
<h4 id="321-规划">3.2.1 规划：</h4>
<p>master: 192.168.10.10<br />
slave: 192.168.10.11, 192.168.10.11</p>

<h4 id="322修改配置">3.2.2修改配置</h4>
<p>redis主从复制配置很简单，只需配置在从节点的配置文件项即可</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Master-Slave replication. Use slaveof to make a Redis instance a copy of</span>
<span class="c"># another Redis server. A few things to understand ASAP about Redis replication.</span>
<span class="c">#</span>
<span class="c"># 1) Redis replication is asynchronous, but you can configure a master to</span>
<span class="c">#    stop accepting writes if it appears to be not connected with at least</span>
<span class="c">#    a given number of slaves.</span>
<span class="c"># 2) Redis slaves are able to perform a partial resynchronization with the</span>
<span class="c">#    master if the replication link is lost for a relatively small amount of</span>
<span class="c">#    time. You may want to configure the replication backlog size (see the next</span>
<span class="c">#    sections of this file) with a sensible value depending on your needs.</span>
<span class="c"># 3) Replication is automatic and does not need user intervention. After a</span>
<span class="c">#    network partition slaves automatically try to reconnect to masters</span>
<span class="c">#    and resynchronize with them.</span>
<span class="c">#</span>
<span class="c"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span>
</code></pre></div></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>slaveof 192.168.10.10 6379
</code></pre></div></div>
<p>从节点就可以从192.168.10.10上复制数据了。<br />
启动master，slave 主从复制就配置完成了。</p>

<h2 id="4-sentinel">4. Sentinel</h2>
<p>Sentinel是一个不提供读写功能的redis server，用来监控redis server的状态，在redis server主从复制master出现故障时，
完成failover，保证高可用。</p>
<h3 id="41配置sentinel">4.1配置Sentinel</h3>
<p>配置3个配置Sentinel节点（至于为什么是3个而不是2个或者4个，这个涉及到leader的选举，不是这个的重点）</p>
<ul>
  <li>Sentinel node1: 192.168.10.20</li>
  <li>Sentinel node2: 192.168.10.21</li>
  <li>Sentinel node3: 192.168.10.22</li>
</ul>

<p>这3个节点的配置是一样的，以一个节点为例子。</p>
<h4 id="411-配置网络">4.1.1 配置网络</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Example sentinel.conf</span>

<span class="c"># *** IMPORTANT ***</span>
<span class="c">#</span>
<span class="c"># By default Sentinel will not be reachable from interfaces different than</span>
<span class="c"># localhost, either use the 'bind' directive to bind to a list of network</span>
<span class="c"># interfaces, or disable protected mode with "protected-mode no" by</span>
<span class="c"># adding it to this configuration file.</span>
<span class="c">#</span>
<span class="c"># Before doing that MAKE SURE the instance is protected from the outside</span>
<span class="c"># world via firewalling or other means.</span>
<span class="c">#</span>
<span class="c"># For example you may use one of the following:</span>
<span class="c">#</span>
<span class="c"># bind 127.0.0.1 192.168.1.1</span>
<span class="nb">bind </span>0.0.0.0
<span class="c">#</span>
protected-mode no

<span class="c"># port &lt;sentinel-port&gt;</span>
<span class="c"># The port that this sentinel instance will run on</span>
port 26379
</code></pre></div></div>

<ul>
  <li>bind: 绑定网络接口, 这里为了方便，bind了所有的接口</li>
  <li>protected-mode： 关闭了保护模式</li>
  <li>port： 监听端口，这是使用了默认值26379</li>
</ul>

<h4 id="412-配置monitor">4.1.2 配置monitor</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>
<span class="c">#</span>
<span class="c"># Tells Sentinel to monitor this master, and to consider it in O_DOWN</span>
<span class="c"># (Objectively Down) state only if at least &lt;quorum&gt; sentinels agree.</span>
<span class="c">#</span>
<span class="c"># Note that whatever is the ODOWN quorum, a Sentinel will require to</span>
<span class="c"># be elected by the majority of the known Sentinels in order to</span>
<span class="c"># start a failover, so no failover can be performed in minority.</span>
<span class="c">#</span>
<span class="c"># Slaves are auto-discovered, so you don't need to specify slaves in</span>
<span class="c"># any way. Sentinel itself will rewrite this configuration file adding</span>
<span class="c"># the slaves using additional configuration options.</span>
<span class="c"># Also note that the configuration file is rewritten when a</span>
<span class="c"># slave is promoted to master.</span>
<span class="c">#</span>
<span class="c"># Note: master name should not include special characters or spaces.</span>
<span class="c"># The valid charset is A-z 0-9 and the three characters ".-_".</span>
sentinel monitor mymaster 192.168.10.10 6379 2
</code></pre></div></div>
<p>这个配置项的格式是：sentinel monitor <master-name> <ip> <redis-port> <quorum></quorum></redis-port></ip></master-name></p>
<ul>
  <li>master-name: 给master起个名字，用于区分不同master。因为一个sentinel可以监控n组master</li>
  <li>ip: redis server master的ip</li>
  <li>redis-port: redis server master的端口</li>
  <li>quorum：法定票数，故障判定时使用</li>
</ul>

<h4 id="413-其他配置">4.1.3 其他配置</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemonize yes
logfile <span class="s2">"/root/redis/sentinel.log"</span>
</code></pre></div></div>
<ul>
  <li>daemonize: 配置 sentinel 以 daemonize 方式启动</li>
  <li>logfile： sentinel 的日志文件</li>
</ul>

<h3 id="42-测试">4.2 测试</h3>
<h4 id="421-启动sentinel">4.2.1 启动sentinel</h4>
<p>在3个节点上启动 sentinel</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis-sentinel sentinel.conf
</code></pre></div></div>
<p>连接一个 sentinel ，看看状态</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis-cli <span class="nt">-p</span> 26379
</code></pre></div></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:26379&gt; info sentinel
<span class="c"># Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name<span class="o">=</span>mymaster,status<span class="o">=</span>ok,address<span class="o">=</span>192.168.10.10:6379,slaves<span class="o">=</span>2,sentinels<span class="o">=</span>3
</code></pre></div></div>
<p>可以看出，master的name为mymaster, 状态ok, ip为192.168.10.10，端口为6379，有2个slave, 3个sentinel</p>

<h4 id="422-故障转移">4.2.2 故障转移</h4>
<p>模拟 master 故障， 这里 kill 调 redis server master 进程</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node2 redis]# ps <span class="nt">-ef</span> | <span class="nb">grep </span>6379
root       8543      1  0 13:56 ?        00:00:23 /usr/local/bin/redis-server 0.0.0.0:6379     
root       9774   7749  0 18:39 pts/1    00:00:00 <span class="nb">grep </span>6379
<span class="o">[</span>root@node2 redis]# <span class="nb">kill</span> <span class="nt">-9</span> 8543

</code></pre></div></div>
<p>连接 sentinel 上查看状态</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node2 redis]# redis-cli <span class="nt">-p</span> 26379
127.0.0.1:26379&gt; info sentinel
<span class="c"># Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name<span class="o">=</span>mymaster,status<span class="o">=</span>odown,address<span class="o">=</span>192.168.10.12:6379,slaves<span class="o">=</span>2,sentinels<span class="o">=</span>3
</code></pre></div></div>
<p>可以看到 master 的地址已经变了，已经完成了故障转移。</p>

<h2 id="5-cluster">5. Cluster</h2>
<h3 id="51-环境">5.1 环境</h3>
<p>节点:</p>
<ul>
  <li>node1: 192.168.10.10 8000</li>
  <li>node2: 192.168.10.11 8000</li>
  <li>node3: 192.168.10.12 8000</li>
  <li>node4: 192.168.10.10 8001</li>
  <li>node5: 192.168.10.11 8002</li>
  <li>node6: 192.168.10.12 8003</li>
</ul>

<table>
  <thead>
    <tr>
      <th>mstart-slave</th>
      <th>master</th>
      <th>slave</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mstart-slave</td>
      <td>node1</td>
      <td>node4</td>
    </tr>
    <tr>
      <td>mstart-slave</td>
      <td>node2</td>
      <td>node5</td>
    </tr>
    <tr>
      <td>mstart-slave</td>
      <td>node3</td>
      <td>node6</td>
    </tr>
  </tbody>
</table>

<p>注意：这里为了方便，master 和 slave 放在同一台机器上了，如果是生成环境绝对绝对不要这样！！！</p>

<h3 id="52-cluster配置">5.2 Cluster配置</h3>
<h4 id="521-配置开启节点">5.2.1 配置开启节点</h4>
<ul>
  <li>master 节点配置
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">bind </span>0.0.0.0
port 8000  
cluster-enabled yes  
cluster-config-file nodes-8000.conf  
cluster-node-timeout 15000  
dir <span class="s2">"/root/redis/data/"</span>
appendonly yes  
appendfilename <span class="s2">"appendonly-8000.aof"</span>  
logfile <span class="s2">"8000.log"</span>  
daemonize yes  
pidfile /var/run/redis-8000.pid   
dbfilename <span class="s2">"dump-8000.rdb"</span>
logfile <span class="s2">"/root/redis/log/redis_8000.log"</span>
</code></pre></div>    </div>
  </li>
  <li>slave 节点配置， salve节点配置是和master节点配置一样的。这里master和slave部署在同一台机器上，要做端口区分。
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed <span class="s1">'s/8000/8001/g'</span> redis-8000.conf <span class="o">&gt;</span> redis-8001.conf
</code></pre></div>    </div>
  </li>
</ul>

<p>启动6个节点</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis-server 8000.conf
redis-server 8001.conf
</code></pre></div></div>

<p>查看节点启动情况</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master redis]# ps <span class="nt">-ef</span> | <span class="nb">grep </span>redis-server
root       2336      1  0 12:23 ?        00:00:51 redis-server 0.0.0.0:8000 <span class="o">[</span>cluster]
root       2358      1  0 12:25 ?        00:00:34 redis-server 0.0.0.0:8001 <span class="o">[</span>cluster]
</code></pre></div></div>
<p>查看单个节点</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master redis]# redis-cli <span class="nt">-c</span> <span class="nt">-p</span> 8000
127.0.0.1:8000&gt; CLUSTER INFO
cluster_state:fail
cluster_slots_assigned:0
cluster_slots_ok:0
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:1
cluster_size:0
cluster_current_epoch:0
cluster_my_epoch:0
cluster_stats_messages_sent:0
cluster_stats_messages_received:0
</code></pre></div></div>

<h4 id="522-meet">5.2.2 meet</h4>
<p>在192.168.10.10上， 利用redis-cli连接到8000，然后meet 其他节点</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master redis]# redis-cli -c -p 8000
127.0.0.1:8000&gt; CLUSTER MEET 192.168.10.10 8001
OK
127.0.0.1:8000&gt; CLUSTER MEET 192.168.10.11 8000
OK
127.0.0.1:8000&gt; CLUSTER MEET 192.168.10.11 8001
OK
127.0.0.1:8000&gt; CLUSTER MEET 192.168.10.12 8000
OK
127.0.0.1:8000&gt; CLUSTER MEET 192.168.10.12 8001
OK
</code></pre></div></div>
<p>查看节点</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:8000&gt; CLUSTER NODES
8b496ced472ff6913a079cb56bba8bd9cee12c61 192.168.95.128:8000 myself,master - 0 0 2 connected 0-5460
b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e 192.168.95.135:8000 master - 0 1491638444324 8 connected 5461-10992
eddca3c1b37b3574f511422b213fd2085f8e17a2 192.168.95.135:8001 slave b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e 0 1491638442304 8 connected
f91b42c1f481297d5347b7b518cca39ee14200ce 192.168.95.136:8000 master - 0 1491638441294 0 connected 10993-16383
f2be65c867349aaab162124174a2f1b1848bb4ab 192.168.95.136:8001 slave f91b42c1f481297d5347b7b518cca39ee14200ce 0 1491638440789 5 connected
3ca09eba65a2fa42275aa30d80999b59bd4e2085 192.168.95.128:8001 slave 8b496ced472ff6913a079cb56bba8bd9cee12c61 0 1491638443314 2 connected
127.0.0.1:8000&gt; 
</code></pre></div></div>

<h4 id="523-指派槽">5.2.3 指派槽</h4>
<p>分派slots</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cluster addslots &lt;slot&gt; <span class="o">[</span>slot ...] 将一个或多个槽（slot）指派（assign）给当前节点。
</code></pre></div></div>
<p>redis-cli -c -p 8000 cluster addslots 0 1 2 … <br />
redis-cli 未实现0-5462这样的参数，必须一个个输入。 <br />
所以利用shell生成最终的命令 addslot.sh</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /bin/sh</span>
<span class="nv">start</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">end</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">ip</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">port</span><span class="o">=</span><span class="nv">$4</span>

<span class="k">for </span>slot <span class="k">in</span> <span class="sb">`</span>seq <span class="k">${</span><span class="nv">start</span><span class="k">}</span> <span class="k">${</span><span class="nv">end</span><span class="k">}</span><span class="sb">`</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"slot:</span><span class="k">${</span><span class="nv">slot</span><span class="k">}</span><span class="s2">"</span>
    redis-cli <span class="nt">-c</span> <span class="nt">-h</span> <span class="k">${</span><span class="nv">ip</span><span class="k">}</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">port</span><span class="k">}</span> cluster addslots <span class="k">${</span><span class="nv">slot</span><span class="k">}</span>
<span class="k">done</span>
</code></pre></div></div>
<p>执行：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./addslot.sh 0 5460 192.168.10.10 8000
./addslot.sh 5461 10922 192.168.10.11 8000
./addslot.sh 10923 16383 192.168.10.12 8000
</code></pre></div></div>
<p>查看集群信息</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:8000&gt; CLUSTER INFO
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:0
cluster_my_epoch:0
cluster_stats_messages_sent:0
cluster_stats_messages_received:0
</code></pre></div></div>
<p>配置主从关系</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cluster replicate &lt;node_id&gt; 将当前节点设置为 node_id 指定的节点的从节点
</code></pre></div></div>
<p>以node4举例</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master redis]# redis-cli -c -p 8001
127.0.0.1:8001&gt; CLUSTER NODES
8b496ced472ff6913a079cb56bba8bd9cee12c61 192.168.10.10:8000 myself,master - 0 0 2 connected 0-5460
b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e 192.168.10.11:8000 master - 0 1491638444324 8 connected 5461-10992
eddca3c1b37b3574f511422b213fd2085f8e17a2 192.168.10.11:8001 master 
f91b42c1f481297d5347b7b518cca39ee14200ce 192.168.10.12:8000 master - 0 1491638441294 0 connected 10993-16383
f2be65c867349aaab162124174a2f1b1848bb4ab 192.168.10.12:8001 master 
3ca09eba65a2fa42275aa30d80999b59bd4e2085 192.168.10.10:8001 master 
127.0.0.1:8001&gt; CLUSTER REPLICATE 8b496ced472ff6913a079cb56bba8bd9cee12c61
OK
</code></pre></div></div>
<p>node4的masterde的节点id是：8b496ced472ff6913a079cb56bba8bd9cee12c61 <br />
所以是</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CLUSTER REPLICATE 8b496ced472ff6913a079cb56bba8bd9cee12c61
</code></pre></div></div>
<p>在note5和node6节点上依次配置其master的节点id即可。</p>

<p>查看节点</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:8000&gt; CLUSTER NODES
8b496ced472ff6913a079cb56bba8bd9cee12c61 192.168.10.10:8000 myself,master - 0 0 2 connected 0-5460
b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e 192.168.10.11:8000 master - 0 1491638444324 8 connected 5461-10992
eddca3c1b37b3574f511422b213fd2085f8e17a2 192.168.10.11:8001 slave b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e 0 1491638442304 8 connected
f91b42c1f481297d5347b7b518cca39ee14200ce 192.168.10.12:8000 master - 0 1491638441294 0 connected 10993-16383
f2be65c867349aaab162124174a2f1b1848bb4ab 192.168.10.12:8001 slave f91b42c1f481297d5347b7b518cca39ee14200ce 0 1491638440789 5 connected
3ca09eba65a2fa42275aa30d80999b59bd4e2085 192.168.10.10:8001 slave 8b496ced472ff6913a079cb56bba8bd9cee12c61 0 1491638443314 2 connected
</code></pre></div></div>
<p>确认分配槽状态</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:8000&gt; CLUSTER SLOTS
1) 1) (integer) 0
   2) (integer) 5460
   3) 1) "192.168.10.10"
      2) (integer) 8000
      3) "8b496ced472ff6913a079cb56bba8bd9cee12c61"
   4) 1) "192.168.10.10"
      2) (integer) 8001
      3) "3ca09eba65a2fa42275aa30d80999b59bd4e2085"
2) 1) (integer) 5461
   2) (integer) 10992
   3) 1) "192.168.10.11"
      2) (integer) 8000
      3) "b1b77d1f042f7abe18dbe5f461c7ee0d4a001e7e"
   4) 1) "192.168.10.11"
      2) (integer) 8001
      3) "eddca3c1b37b3574f511422b213fd2085f8e17a2"
3) 1) (integer) 10993
   2) (integer) 16383
   3) 1) "192.168.10.12"
      2) (integer) 8000
      3) "f91b42c1f481297d5347b7b518cca39ee14200ce"
   4) 1) "192.168.10.12"
      2) (integer) 8001
      3) "f2be65c867349aaab162124174a2f1b1848bb4ab"
</code></pre></div></div>

<h4 id="524-测试">5.2.4 测试</h4>
<ul>
  <li>测试集群工作情况</li>
  <li>模拟故障转移</li>
</ul>

<p>这两步测试省略。</p>

<h3 id="53-官方工具搭建集群">5.3 官方工具搭建集群</h3>
<p>机器需要支持Ruby环境，因为工具是使用Ruby写的。  <br />
脚本名字：redis-trib.rb</p>

<h2 id="6-水平扩容">6. 水平扩容</h2>

<h2 id="7-cachecould">7. CacheCould</h2>
<p><a href="https://cachecloud.github.io/2016/04/12/CacheCloud%E6%96%87%E6%A1%A3%E5%BD%92%E6%A1%A3/">CacheCloud文档归档</a>  <br />
<a href="https://github.com/sohutv/cachecloud/wiki">github</a></p>

  </div>

  
</article>


      <footer class="site-footer">
        <!-- SVG icons from https://iconmonstr.com -->

        <!-- Github icon -->
        <span class="my-span-icon">
          <a href="https://github.com/jylaxp" aria-label="jylaxp's GitHub" title="jylaxp's GitHub">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
        </span>

        <!-- Twitter icon
        <span class="my-span-icon">
          <a href="https://twitter.com/" aria-label="jylaxp's Twitter" title="jylaxp's Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>
 -->
        <!-- RSS icon -->
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact jylaxp">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        

      </footer>
    </section>

    
  </body>
</html>
