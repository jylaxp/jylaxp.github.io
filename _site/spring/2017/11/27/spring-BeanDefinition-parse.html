<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Spring 之 BeanDefinition解析</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="jylaxp">

<meta name="description" content="上篇分析了BeanDefinition的属性和使用场景，这篇我们分析BeanDefinition是如何解析和注册的。我们最常用的bean定义是通过xml和注解的方式，所以这里就只分析这两种方式的bean解析。 xml方式 我们从XmlWebApplicationContext这个类入手分析，为什么..." />




  <meta name="keywords" itemprop="category" content="">


<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Spring 之 BeanDefinition解析">
<meta itemprop="description" content="上篇分析了BeanDefinition的属性和使用场景，这篇我们分析BeanDefinition是如何解析和注册的。我们最常用的bean定义是通过xml和注解的方式，所以这里就只分析这两种方式的bean解析。 xml方式 我们从XmlWebApplicationContext这个类入手分析，为什么...">

  <meta itemprop="image" content="http://localhost:4000">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Spring 之 BeanDefinition解析">
<meta name="twitter:description" content="上篇分析了BeanDefinition的属性和使用场景，这篇我们分析BeanDefinition是如何解析和注册的。我们最常用的bean定义是通过xml和注解的方式，所以这里就只分析这两种方式的bean解析。 xml方式 我们从XmlWebApplicationContext这个类入手分析，为什么...">



<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="http://localhost:4000">
  <meta property="twitter:image" content="http://localhost:4000">

<meta property="twitter:url" content="http://localhost:4000/spring/2017/11/27/spring-BeanDefinition-parse.html">

<!-- Open Graph data -->
<meta property="og:title" content="Spring 之 BeanDefinition解析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/spring/2017/11/27/spring-BeanDefinition-parse.html" />

  <meta property="og:image" content="http://localhost:4000" />

<meta property="og:description" content="上篇分析了BeanDefinition的属性和使用场景，这篇我们分析BeanDefinition是如何解析和注册的。我们最常用的bean定义是通过xml和注解的方式，所以这里就只分析这两种方式的bean解析。 xml方式 我们从XmlWebApplicationContext这个类入手分析，为什么..." />
<meta property="og:site_name" content="jylaxp's Blog" />

  <meta property="article:published_time" content="2017-11-27T00:00:00+08:00" />














  





  
    <meta property="article:tag" content="Spring">
  



  <meta property="article:tag" content="">


    

    <link rel="canonical" href="http://localhost:4000/spring/2017/11/27/spring-BeanDefinition-parse.html">

    

    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">jylaxp&#39;s Blog</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
              
                <a class="page-link" href="/contact.html">Contact</a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Spring 之 BeanDefinition解析</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2017-11-27T00:00:00+08:00" itemprop="datePublished">
          
          Nov 27, 2017
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">jylaxp</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Spring 之 BeanDefinition解析</h1>
    <p class="post-meta">
      <time datetime="2017-11-27T00:00:00+08:00" itemprop="datePublished">
        
        Nov 27, 2017
      </time>
      </p>
  </header> -->

  <div itemprop="articleBody">
    <p>上篇分析了BeanDefinition的属性和使用场景，这篇我们分析BeanDefinition是如何解析和注册的。我们最常用的bean定义是通过xml和注解的方式，所以这里就只分析这两种方式的bean解析。</p>
<h3 id="xml方式">xml方式</h3>
<p>我们从XmlWebApplicationContext这个类入手分析，为什么是这个类，请参考<a href="https://jylaxp.github.io/spring/2017/11/22/ContextLoaderListener-And-DispatcherServlet.html">Spring 初始化 ContextLoaderListener 与 DispatcherServlet</a></p>

<p>XmlWebApplicationContext类的继承关系
<img src="http://localhost:4000/assets/blog-img/2017-11-27-spring-BeanDefinition-parse/XmlWebApplicationContext.png" alt="" /></p>

<p>入口在AbstractApplicationContext类的refresh()方法。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="o">,</span> <span class="n">IllegalStateException</span> <span class="o">{</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Prepare this context for refreshing.</span>
		<span class="n">prepareRefresh</span><span class="o">();</span>

		<span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
		<span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

		<span class="c1">// Prepare the bean factory for use in this context.</span>
		<span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
			<span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

			<span class="c1">// Invoke factory processors registered as beans in the context.</span>
			<span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

			<span class="c1">// Register bean processors that intercept bean creation.</span>
			<span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

			<span class="c1">// Initialize message source for this context.</span>
			<span class="n">initMessageSource</span><span class="o">();</span>

			<span class="c1">// Initialize event multicaster for this context.</span>
			<span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

			<span class="c1">// Initialize other special beans in specific context subclasses.</span>
			<span class="n">onRefresh</span><span class="o">();</span>

			<span class="c1">// Check for listener beans and register them.</span>
			<span class="n">registerListeners</span><span class="o">();</span>

			<span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
			<span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

			<span class="c1">// Last step: publish corresponding event.</span>
			<span class="n">finishRefresh</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">catch</span> <span class="o">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
						<span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
			<span class="n">destroyBeans</span><span class="o">();</span>

			<span class="c1">// Reset 'active' flag.</span>
			<span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

			<span class="c1">// Propagate exception to caller.</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">finally</span> <span class="o">{</span>
			<span class="c1">// Reset common introspection caches in Spring's core, since we</span>
			<span class="c1">// might not ever need metadata for singleton beans anymore...</span>
			<span class="n">resetCommonCaches</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>跟进obtainFreshBeanFactory()方法，该方法获取beanFactory，获取到的beanFactory已经是完成了BeanDefinition的注册。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Tell the subclass to refresh the internal bean factory.
 * @return the fresh BeanFactory instance
 * @see #refreshBeanFactory()
 * @see #getBeanFactory()
 */</span>
<span class="kd">protected</span> <span class="n">ConfigurableListableBeanFactory</span> <span class="nf">obtainFreshBeanFactory</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">refreshBeanFactory</span><span class="o">();</span>
	<span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean factory for "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">beanFactory</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">beanFactory</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>跟进refreshBeanFactory()方法，该方法的在AbstractRefreshableApplicationContext类中实现</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * This implementation performs an actual refresh of this context's underlying
 * bean factory, shutting down the previous bean factory (if any) and
 * initializing a fresh bean factory for the next phase of the context's lifecycle.
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refreshBeanFactory</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">hasBeanFactory</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">destroyBeans</span><span class="o">();</span>
		<span class="n">closeBeanFactory</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">createBeanFactory</span><span class="o">();</span>
		<span class="n">beanFactory</span><span class="o">.</span><span class="na">setSerializationId</span><span class="o">(</span><span class="n">getId</span><span class="o">());</span>
		<span class="n">customizeBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
		<span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactoryMonitor</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"I/O error parsing bean definition source for "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们看到这里调用了createBeanFactory()创建了beanFactory，下面调用loadBeanDefinitions(beanFactory)进行加载bean定义。loadBeanDefinitions()方法的实现在XmlWebApplicationContext类提供。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Loads the bean definitions via an XmlBeanDefinitionReader.
 * @see org.springframework.beans.factory.xml.XmlBeanDefinitionReader
 * @see #initBeanDefinitionReader
 * @see #loadBeanDefinitions
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
	<span class="c1">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span>
	<span class="n">XmlBeanDefinitionReader</span> <span class="n">beanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

	<span class="c1">// Configure the bean definition reader with this context's</span>
	<span class="c1">// resource loading environment.</span>
	<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">getEnvironment</span><span class="o">());</span>
	<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
	<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">ResourceEntityResolver</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

	<span class="c1">// Allow a subclass to provide custom initialization of the reader,</span>
	<span class="c1">// then proceed with actually loading the bean definitions.</span>
	<span class="n">initBeanDefinitionReader</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
	<span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>到这里，才是真正的开始和beanDefinition解析相关了，前面的代码都是引子。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span>
<span class="n">XmlBeanDefinitionReader</span> <span class="n">beanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
</code></pre></div></div>
<p>首先，创建了一个XmlBeanDefinitionReader，看名字就只可以知道，这个XmlBeanDefinitionReader要干的事情就是就是从xml读取BeanDefinition。XmlBeanDefinitionReader的构造方法的参数这里参入的beanFactory，我们臆测，XmlBeanDefinitionReader读取的BeanDefinition就是注册到这个beanFacctory容器里的。看一下XmlBeanDefinitionReader的构方法，参数类型是BeanDefinitionRegistr，这个是一个接口，提供BeanDefinition注册功能，可以看一下DefaultListableBeanFactory类的关系，可以看到DefaultListableBeanFactory实现了BeanDefinitionRegistry接口。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Create new XmlBeanDefinitionReader for the given bean factory.
 * @param registry the BeanFactory to load bean definitions into,
 * in the form of a BeanDefinitionRegistry
 */</span>
<span class="kd">public</span> <span class="nf">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Configure the bean definition reader with this context's</span>
<span class="c1">// resource loading environment.</span>
<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">getEnvironment</span><span class="o">());</span>
<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">ResourceEntityResolver</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
</code></pre></div></div>
<p>接着，配置BeanDefinitionReader上下文使用的环境，资源加载器等，<strong>这里的资源加载器设置的this, 也就是XmlWebApplicationContext</strong>。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Allow a subclass to provide custom initialization of the reader,</span>
<span class="c1">// then proceed with actually loading the bean definitions.</span>
<span class="n">initBeanDefinitionReader</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
<span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
</code></pre></div></div>
<p>然后是初始化BeanDefinitionReader，initBeanDefinitionReader(beanDefinitionReader)，这个是一个空方法，其实这是扩展点，留给子类实现，来对beanDefinitionReader进行一些操作。下面的loadBeanDefinitions(beanDefinitionReader)这个行代码是重点，跟进去一探究竟。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">XmlBeanDefinitionReader</span> <span class="n">reader</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
	<span class="n">String</span><span class="o">[]</span> <span class="n">configLocations</span> <span class="o">=</span> <span class="n">getConfigLocations</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">configLocations</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">configLocation</span> <span class="o">:</span> <span class="n">configLocations</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configLocation</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>调用getConfigLocations()方法定位配置文件信息，它获取的其实就是在web.xml配置的contextConfigLocation的param-value。</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
	<span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
	<span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/*.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</code></pre></div></div>
<p>为什么是String[], 应为param-value节点的值可以是多个啊，我可以配置这样</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
	<span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
	<span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/1.xml classpath*:META-INF/spring/2.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</code></pre></div></div>
<p>代码接着往下看，reader.loadBeanDefinitions(configLocation)，控制权交给了XmlBeanDefinitionReader，我们分析这个类。先看一下类的关系。</p>

<p><img src="http://localhost:4000/assets/blog-img/2017-11-27-spring-BeanDefinition-parse/XmlBeanDefinitionReader.png" alt="" /></p>

<p>我们跟一下reader.loadBeanDefinitions(configLocation)这方法，这个方法在AbstractBeanDefinitionReader类中</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">String</span> <span class="n">location</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">String</span> <span class="n">location</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&gt;</span> <span class="n">actualResources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="n">ResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="n">getResourceLoader</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">resourceLoader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
				<span class="s">"Cannot import bean definitions from location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]: no ResourceLoader available"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">resourceLoader</span> <span class="k">instanceof</span> <span class="n">ResourcePatternResolver</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Resource pattern matching available.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">Resource</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="o">((</span><span class="n">ResourcePatternResolver</span><span class="o">)</span> <span class="n">resourceLoader</span><span class="o">).</span><span class="na">getResources</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
			<span class="kt">int</span> <span class="n">loadCount</span> <span class="o">=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">actualResources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">actualResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loaded "</span> <span class="o">+</span> <span class="n">loadCount</span> <span class="o">+</span> <span class="s">" bean definitions from location pattern ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">loadCount</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
					<span class="s">"Could not resolve bean definition resource pattern ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// Can only load single resources by absolute URL.</span>
		<span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">loadCount</span> <span class="o">=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">actualResources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">actualResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loaded "</span> <span class="o">+</span> <span class="n">loadCount</span> <span class="o">+</span> <span class="s">" bean definitions from location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">loadCount</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">Resource</span><span class="o">...</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">resources</span><span class="o">,</span> <span class="s">"Resource array must not be null"</span><span class="o">);</span>
	<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">counter</span> <span class="o">+=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">counter</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>第一个loadBeanDefinitions没什么可说的，我们看第二个loadBeanDefinitions。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="n">getResourceLoader</span><span class="o">();</span>
</code></pre></div></div>
<p>这行代码获取的就是之前设置的资源加载器——XmlWebApplicationContext，通过它的类关系图，可以知道它间接实现了ResourcePatternResolver接口，所以会走下面的if分支。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">resourceLoader</span> <span class="k">instanceof</span> <span class="n">ResourcePatternResolver</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// Resource pattern matching available.</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">Resource</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="o">((</span><span class="n">ResourcePatternResolver</span><span class="o">)</span> <span class="n">resourceLoader</span><span class="o">).</span><span class="na">getResources</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">loadCount</span> <span class="o">=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">actualResources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">actualResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loaded "</span> <span class="o">+</span> <span class="n">loadCount</span> <span class="o">+</span> <span class="s">" bean definitions from location pattern ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">loadCount</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
				<span class="s">"Could not resolve bean definition resource pattern ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Resource</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="o">((</span><span class="n">ResourcePatternResolver</span><span class="o">)</span> <span class="n">resourceLoader</span><span class="o">).</span><span class="na">getResources</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
</code></pre></div></div>
<p>这行代码，完成了通配符的匹配，资源文件的定位。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">loadCount</span> <span class="o">=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
</code></pre></div></div>
<p>这个行代码就是调用的第三个loadBeanDefinitions，第三个loadBeanDefinitions又调用了loadBeanDefinitions，真是”这里的山路十八弯, 这里的水路九连环”啊，命令一层一层的下达，到现在还没有找到干活的人，全是协调组织者，真像是国家的行政机关啊，全是开证明盖章的。跟进去吧～，这个方法在XmlBeanDefinitionReader类中。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="k">new</span> <span class="n">EncodedResource</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="n">EncodedResource</span> <span class="n">encodedResource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">,</span> <span class="s">"EncodedResource must not be null"</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Loading XML bean definitions from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="n">Set</span><span class="o">&lt;</span><span class="n">EncodedResource</span><span class="o">&gt;</span> <span class="n">currentResources</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">currentResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">EncodedResource</span><span class="o">&gt;(</span><span class="mi">4</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentResources</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">currentResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
				<span class="s">"Detected cyclic loading of "</span> <span class="o">+</span> <span class="n">encodedResource</span> <span class="o">+</span> <span class="s">" - check your import definitions!"</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">InputSource</span> <span class="n">inputSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">inputSource</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
				<span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">finally</span> <span class="o">{</span>
		<span class="n">currentResources</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>啪啪，又盖了两个章。逻辑很简单，就是获取InputStream输入流，也就是打开文件，然后调doLoadBeanDefinitions(inputSource, encodedResource.getResource())干活，不容易啊，终于找到干活的了。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="n">InputSource</span> <span class="n">inputSource</span><span class="o">,</span> <span class="n">Resource</span> <span class="n">resource</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">doLoadDocument</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
		<span class="k">return</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">SAXParseException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">XmlBeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
				<span class="s">"Line "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getLineNumber</span><span class="o">()</span> <span class="o">+</span> <span class="s">" in XML document from "</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s">" is invalid"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">SAXException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">XmlBeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
				<span class="s">"XML document from "</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s">" is invalid"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">ParserConfigurationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
				<span class="s">"Parser configuration exception parsing XML from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
				<span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
				<span class="s">"Unexpected exception parsing XML document from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>关键代码就两行</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">doLoadDocument</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
</code></pre></div></div>
<p>读取资源xml文件，验证xml文件，解析xml成Document。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
</code></pre></div></div>
<p>注册BeanDefinition。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="n">Document</span> <span class="n">doc</span><span class="o">,</span> <span class="n">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="o">{</span>
	<span class="n">BeanDefinitionDocumentReader</span> <span class="n">documentReader</span> <span class="o">=</span> <span class="n">createBeanDefinitionDocumentReader</span><span class="o">();</span>
	<span class="kt">int</span> <span class="n">countBefore</span> <span class="o">=</span> <span class="n">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">();</span>
	<span class="n">documentReader</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">createReaderContext</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
	<span class="k">return</span> <span class="nf">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">countBefore</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>这里创建了BeanDefinitionDocumentReader对象来解析注册BeanDefinition，有一点要注意</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">documentReader</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">createReaderContext</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
</code></pre></div></div>
<p>这个行代码里的createReaderContext(resource)，它是获取一个XmlReaderContext对象，解析BeanDefinition要用到的上下文，它为自定义spring schemas提供了扩展，以注解定义的BeanDefinition的解析也是通过这种方式做的扩展，这里不深入分析，在后面分析解析以注解方式定义的bean时在深入的研究。</p>


  </div>

  
</article>


      <footer class="site-footer">
        <!-- SVG icons from https://iconmonstr.com -->

        <!-- Github icon -->
        <span class="my-span-icon">
          <a href="https://github.com/jylaxp" aria-label="jylaxp's GitHub" title="jylaxp's GitHub">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
        </span>

        <!-- Twitter icon
        <span class="my-span-icon">
          <a href="https://twitter.com/" aria-label="jylaxp's Twitter" title="jylaxp's Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>
 -->
        <!-- RSS icon -->
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact jylaxp">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        

      </footer>
    </section>

    
  </body>
</html>
