<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Spring Security 过滤链和过滤器(一)</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="jylaxp">

<meta name="description" content="Spring Security 的过滤链如下" />




  <meta name="keywords" itemprop="category" content="">


<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Spring Security 过滤链和过滤器(一)">
<meta itemprop="description" content="Spring Security 的过滤链如下">

  <meta itemprop="image" content="http://localhost:4000">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Spring Security 过滤链和过滤器(一)">
<meta name="twitter:description" content="Spring Security 的过滤链如下">



<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="http://localhost:4000">
  <meta property="twitter:image" content="http://localhost:4000">

<meta property="twitter:url" content="http://localhost:4000/spring/2018/08/01/springSecurity1.html">

<!-- Open Graph data -->
<meta property="og:title" content="Spring Security 过滤链和过滤器(一)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/spring/2018/08/01/springSecurity1.html" />

  <meta property="og:image" content="http://localhost:4000" />

<meta property="og:description" content="Spring Security 的过滤链如下" />
<meta property="og:site_name" content="jylaxp's Blog" />

  <meta property="article:published_time" content="2018-08-01T00:00:00+08:00" />














  





  
    <meta property="article:tag" content="spring">
  



  <meta property="article:tag" content="">


    

    <link rel="canonical" href="http://localhost:4000/spring/2018/08/01/springSecurity1.html">

    

    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">jylaxp&#39;s Blog</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
              
                <a class="page-link" href="/contact.html">Contact</a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Spring Security 过滤链和过滤器(一)</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-08-01T00:00:00+08:00" itemprop="datePublished">
          
          Aug 1, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">jylaxp</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Spring Security 过滤链和过滤器(一)</h1>
    <p class="post-meta">
      <time datetime="2018-08-01T00:00:00+08:00" itemprop="datePublished">
        
        Aug 1, 2018
      </time>
      </p>
  </header> -->

  <div itemprop="articleBody">
    <h3 id="spring-security-的过滤链如下">Spring Security 的过滤链如下</h3>

<ol>
  <li>SecurityContextPersistenceFilter</li>
  <li>WebAsyncManagerIntegrationFilter</li>
  <li>HeaderWriterFilter</li>
  <li>CsrfFilter</li>
  <li>LogoutFilter</li>
  <li>UsernamePasswordAuthenticationFilter</li>
  <li>DefaultLoginPageGeneratingFilter</li>
  <li>BasicAuthenticationFilter</li>
  <li>RequestCacheAwareFilter</li>
  <li>SecurityContextHolderAwareRequestFilter</li>
  <li>AnonymousAuthenticationFilter</li>
  <li>SessionManagementFilter</li>
  <li>ExceptionTranslationFilter</li>
  <li>FilterSecurityInterceptor</li>
</ol>

<h3 id="1-securitycontextpersistencefilter">1. SecurityContextPersistenceFilter</h3>
<p>该过滤器位于在过滤链第一个位置，主要功能是从session中加载SecurityContex，如果session中不存在SecurityContex，则创建新的SecurityContex,然后执行过滤链中后续的过滤器。在后续过滤器返回后，保存SecurityContex到session中。它其实是在为后续的过滤器准备安全上下文环境和后续的扫尾工作。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityContextPersistenceFilter</span> <span class="kd">extends</span> <span class="n">GenericFilterBean</span> <span class="o">{</span>

	<span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FILTER_APPLIED</span> <span class="o">=</span> <span class="s">"__spring_security_scpf_applied"</span><span class="o">;</span>

    <span class="cm">/** SecurityContex存储接口 */</span>
	<span class="kd">private</span> <span class="n">SecurityContextRepository</span> <span class="n">repo</span><span class="o">;</span>


	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">req</span><span class="o">;</span>
		<span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">res</span><span class="o">;</span>

        <span class="cm">/** 保证统一个请求只有一个SecurityContext。如果已经创建过SecurityContext了，则直接执行后续过滤器。 */</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">FILTER_APPLIED</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// ensure that filter is only applied once per request</span>
			<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">();</span>

        <span class="cm">/** 设置创建SecurityContext标识 */</span>
		<span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">FILTER_APPLIED</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">forceEagerSessionCreation</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">session</span><span class="o">.</span><span class="na">isNew</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Eagerly created session: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">HttpRequestResponseHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpRequestResponseHolder</span><span class="o">(</span><span class="n">request</span><span class="o">,</span>
				<span class="n">response</span><span class="o">);</span>
		
		<span class="cm">/** 从SecurityContex存储接口加载安全上下文 */</span>
		<span class="n">SecurityContext</span> <span class="n">contextBeforeChainExecution</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="na">loadContext</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
		    <span class="cm">/** 将安全上下文设置到SecurityContextHolder，后续过滤链可以通过SecurityContextHolder获取到安全上下文 */</span>
			<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">contextBeforeChainExecution</span><span class="o">);</span>

            <span class="cm">/** 执行后续过滤链 */</span>
			<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="n">SecurityContext</span> <span class="n">contextAfterChainExecution</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span>
					<span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
			<span class="c1">// Crucial removal of SecurityContextHolder contents - do this before anything</span>
			<span class="c1">// else.</span>
			<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">clearContext</span><span class="o">();</span>
			
			<span class="cm">/** 保存安全上下文 */</span>
			<span class="n">repo</span><span class="o">.</span><span class="na">saveContext</span><span class="o">(</span><span class="n">contextAfterChainExecution</span><span class="o">,</span> <span class="n">holder</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span>
					<span class="n">holder</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
					
			<span class="cm">/** 移除标识 */</span>
			<span class="n">request</span><span class="o">.</span><span class="na">removeAttribute</span><span class="o">(</span><span class="n">FILTER_APPLIED</span><span class="o">);</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"SecurityContextHolder now cleared, as request processing completed"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>执行流程很简单明了</p>
<ul>
  <li>判断是否存在SecurityContex，如果存在，则执行过滤链后返回；</li>
  <li>如果不存在SecurityContex，则设置创建标识，调用SecurityContextRepository接口加载SecurityContex；</li>
  <li>将SecurityContex放在SecurityContextHolder中，后续过滤器可以通过SecurityContextHolder获取SecurityContex；</li>
  <li>执行过滤链；</li>
  <li>保存SecurityContex到Session中</li>
</ul>

<p>这里的SecurityContextRepository是个接口，Spring Security提供了两个实现</p>
<ul>
  <li>HttpSessionSecurityContextRepository</li>
  <li>NullSecurityContextRepository
默认使用的是HttpSessionSecurityContextRepository，将安全上下文存放在Session中。既然是接口，那么我们也可以实现该接口，将安全上下文存在我们指定的地方。</li>
</ul>

<h3 id="2-webasyncmanagerintegrationfilter">2. WebAsyncManagerIntegrationFilter</h3>
<p>该过滤器扩展自OncePerRequestFilter，所以它的核心功能代码只会执行一次。WebAsyncManagerIntegrationFilter通过WebAsyncManager为SecurityContext和Spring Web提供整合功能。</p>

<h3 id="3-headerwriterfilter">3. HeaderWriterFilter</h3>
<p>该过滤器扩展自OncePerRequestFilter，所以它的核心功能代码只会执行一次。该过滤器的功能是在请求返回之给Response添加HttpHeader，可用于开启浏览器保护机制，例如X-Frame-Options, X-XSS-Protection 和 X-Content-Type-Options。</p>

<h3 id="4-csrffilter">4. CsrfFilter</h3>
<p>该过滤器扩展自OncePerRequestFilter，所以它的核心功能代码只会执行一次。该过滤器的功能是在请求中添加csrfToken来防止csrf攻击。这个过滤器会放过GET, HEAD, TRACE, OPTIONS操作的验证，但会在这些请求中添加csrfToke。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CsrfFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">RequestMatcher</span> <span class="n">DEFAULT_CSRF_MATCHER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultRequiresCsrfMatcher</span><span class="o">();</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">CsrfTokenRepository</span> <span class="n">tokenRepository</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">RequestMatcher</span> <span class="n">requireCsrfProtectionMatcher</span> <span class="o">=</span> <span class="n">DEFAULT_CSRF_MATCHER</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">AccessDeniedHandler</span> <span class="n">accessDeniedHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccessDeniedHandlerImpl</span><span class="o">();</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
			<span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
					<span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">response</span><span class="o">);</span>

        <span class="cm">/** 从CsrfTokenRepository中加载csrfToken */</span>
		<span class="n">CsrfToken</span> <span class="n">csrfToken</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">tokenRepository</span><span class="o">.</span><span class="na">loadToken</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">missingToken</span> <span class="o">=</span> <span class="n">csrfToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">missingToken</span><span class="o">)</span> <span class="o">{</span>
		    <span class="cm">/** csrfToken不在，则生成新的csrfToken，并保存到CsrfTokenRepository */</span>
			<span class="n">csrfToken</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">tokenRepository</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">tokenRepository</span><span class="o">.</span><span class="na">saveToken</span><span class="o">(</span><span class="n">csrfToken</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">CsrfToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">csrfToken</span><span class="o">);</span>
		<span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">csrfToken</span><span class="o">.</span><span class="na">getParameterName</span><span class="o">(),</span> <span class="n">csrfToken</span><span class="o">);</span>

        <span class="cm">/** 判断是否忽略该请求的csrf验证 */</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">requireCsrfProtectionMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
		    <span class="cm">/** GET, HEAD, TRACE, OPTIONS 不验证 */</span>
			<span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

        <span class="cm">/** 获取浏览器提交过来的token */</span>
		<span class="n">String</span> <span class="n">actualToken</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">csrfToken</span><span class="o">.</span><span class="na">getHeaderName</span><span class="o">());</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">actualToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">actualToken</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">csrfToken</span><span class="o">.</span><span class="na">getParameterName</span><span class="o">());</span>
		<span class="o">}</span>
		
		<span class="cm">/** 与服务端的token对比 */</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">csrfToken</span><span class="o">.</span><span class="na">getToken</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">actualToken</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Invalid CSRF token found for "</span>
						<span class="o">+</span> <span class="n">UrlUtils</span><span class="o">.</span><span class="na">buildFullRequestUrl</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
			<span class="o">}</span>
			
			<span class="cm">/** token不一致，则交于accessDeniedHandler处理 */</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">missingToken</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span>
						<span class="k">new</span> <span class="nf">MissingCsrfTokenException</span><span class="o">(</span><span class="n">actualToken</span><span class="o">));</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span>
						<span class="k">new</span> <span class="nf">InvalidCsrfTokenException</span><span class="o">(</span><span class="n">csrfToken</span><span class="o">,</span> <span class="n">actualToken</span><span class="o">));</span>
			<span class="o">}</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="o">}</span>


    <span class="cm">/** 默认的RequestMatcher */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DefaultRequiresCsrfMatcher</span> <span class="kd">implements</span> <span class="n">RequestMatcher</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowedMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span>
				<span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"HEAD"</span><span class="o">,</span> <span class="s">"TRACE"</span><span class="o">,</span> <span class="s">"OPTIONS"</span><span class="o">));</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		    <span class="cm">/** GET, HEAD, TRACE, OPTIONS 请求匹配失败，也就是忽略csrfToken的对比 */</span>
			<span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">allowedMethods</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>核心逻辑：</p>
<ul>
  <li>从CsrfTokenRepository中获取csrfToken，如果csrfToken不存在则生成新的csrfToken并保存。这CsrfTokenRepository接口我们可以扩展。</li>
  <li>使用RequestMatcher匹配本次请求，判断是否需要对比csrfToken，如果不需要处理，则执行后续的过滤器。RequestMatcher接口，我们可以根据自己的需求进行自己的实现；默认的RequestMatcher是DefaultRequiresCsrfMatcher，该Matcher的匹配结果是处理除GET, HEAD, TRACE, OPTIONS之外的请求；</li>
  <li>从请求获取浏览器提交过来的token，与服务端的token对比，如果一样，就放过请求，不一样，则交于accessDeniedHandler处理本次请求。我们可以实现自己的AccessDeniedHandler进行替换Spring Security默认提供的AccessDeniedHandlerImpl。</li>
</ul>

<h3 id="5-logoutfilter">5. LogoutFilter</h3>
<p>LogoutFilter处理用户注销登录。默认拦截的方法是POST， 路径是/logout。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutFilter</span> <span class="kd">extends</span> <span class="n">GenericFilterBean</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">RequestMatcher</span> <span class="n">logoutRequestMatcher</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">LogoutHandler</span> <span class="n">handler</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">LogoutSuccessHandler</span> <span class="n">logoutSuccessHandler</span><span class="o">;</span>

	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">req</span><span class="o">;</span>
		<span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">res</span><span class="o">;</span>

        <span class="cm">/** 判断是否需要注销登录 */</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">requiresLogout</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">Authentication</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>

            <span class="cm">/** 注销登录处理器 */</span>
			<span class="k">this</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">logout</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">auth</span><span class="o">);</span>

            <span class="cm">/** 跳转到注销成功页 */</span>
			<span class="n">logoutSuccessHandler</span><span class="o">.</span><span class="na">onLogoutSuccess</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">auth</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="o">}</span>

	 <span class="cm">/** 判断本次请求是否注销登录请求，这里是protected方法，给子类留了扩展的机会 */</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">requiresLogout</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
			<span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">logoutRequestMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>判断是否请求注销登录页面，如果不算，则执行后续过滤器；</li>
  <li>否则，执行注销逻辑。默认的LogoutHandler包含两个handler:CsrfLogoutHandler和SecurityContextLogoutHandle。其中CsrfLogoutHandler销毁CsrfToken，SecurityContextLogoutHandle无效掉Session，销毁授权信息，清楚SeecurityContext;</li>
  <li>跳转到注销成功页面</li>
</ul>

<h3 id="6-usernamepasswordauthenticationfilter">6. UsernamePasswordAuthenticationFilter</h3>
<p>该过滤器扩展自AbstractAuthenticationProcessingFilter，完成基于用户名和密码的身份认证功能。AbstractAuthenticationProcessingFilter是基于HTTP认证请求的抽象处理器，它规范了身份认证流程，把具体的认证逻辑留给不同的认证方式扩展。我们看一下这个身份认证的流程。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>

		<span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">req</span><span class="o">;</span>
		<span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">res</span><span class="o">;</span>

        <span class="cm">/** 判断是否是身份认证请求 */</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">requiresAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">))</span> <span class="o">{</span>
		    <span class="cm">/** 如果不是身份认证请求，则执行后续过滤链 */</span>
			<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Request is to process authentication"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">Authentication</span> <span class="n">authResult</span><span class="o">;</span>

		<span class="k">try</span> <span class="o">{</span>
		    <span class="cm">/** 进行身份认证，获取认证结果。 attemptAuthentication方法留给子类实现 */</span>
			<span class="n">authResult</span> <span class="o">=</span> <span class="n">attemptAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">authResult</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// return immediately as subclass has indicated that it hasn't completed</span>
				<span class="c1">// authentication</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">sessionStrategy</span><span class="o">.</span><span class="na">onAuthentication</span><span class="o">(</span><span class="n">authResult</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">InternalAuthenticationServiceException</span> <span class="n">failed</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span>
					<span class="s">"An internal error occurred while trying to authenticate the user."</span><span class="o">,</span>
					<span class="n">failed</span><span class="o">);</span>
			<span class="cm">/** 身份认证失败 */</span>
			<span class="n">unsuccessfulAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">failed</span><span class="o">);</span>

			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">AuthenticationException</span> <span class="n">failed</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Authentication failed</span>
			<span class="cm">/** 身份认证失败 */</span>
			<span class="n">unsuccessfulAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">failed</span><span class="o">);</span>

			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Authentication success</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">continueChainBeforeSuccessfulAuthentication</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="o">}</span>
        
        <span class="cm">/** 身份认证成功 */</span>
		<span class="n">successfulAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">chain</span><span class="o">,</span> <span class="n">authResult</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>总体流程:</p>
<ul>
  <li>判断请求是否是身份认证请求，如果不是，执行后续的过滤器，如果是，走后面流程；</li>
  <li>调用attemptAuthentication方法完成身份认证。attemptAuthentication方法抽象方法，由子类根据不同的认证方式来完成具体的认证实现，将身份认证的细节从整体流程中剥离出来；</li>
  <li>最后是是身份认证结果的处理。如果认证失败，将控制权交个AuthenticationFailureHandler处理；如果认证成功，控制权交给AuthenticationSuccessHandler处理；</li>
</ul>

<p>身份认证的整体流程很简单，但是，每一步都是都是扩展点。</p>
<ul>
  <li>AuthenticationManager：身份认证管理器，用来完成认证。它只有一个方法<code class="highlighter-rouge">Authentication authenticate(Authentication authentication)</code>，该方法的出入参都是<code class="highlighter-rouge">Authentication</code>;</li>
  <li>Authentication 对用户身份认证信息的抽象，用来提供用户信息和权限，我们可以实现该接口，添加我们自己系统需要使用的用户信息。用户身份认证成功之后， <code class="highlighter-rouge">Authentication</code>会存放在安全上下文<code class="highlighter-rouge">SecurityContextHolder</code>中；</li>
  <li>RequestMatcher 改匹配器用来判断请求是否是用户身份认证请求。<code class="highlighter-rouge">UsernamePasswordAuthenticationFilter</code>默认的匹配器的规则是:POST方法和请求的URL为/login，如果满足这两个条件，则拦截该请求，从请求中提取用户身份认证信息进行认证，否则放过该请求。我们可以实现自己的<code class="highlighter-rouge">RequestMatcher</code>注入到该过滤器中，改变匹配的规则；</li>
  <li>AuthenticationSuccessHandler 用户身份认证成功后会调用此接口，改接口的实现类可以完成目标地址跳转的操作，当然，你也可以有自己的实现；</li>
  <li>AuthenticationFailureHandler 用户身份认证失败会调用此接口，处理认证失败的情况；</li>
</ul>

<p>接下来我们来看看UsernamePasswordAuthenticationFilter对AbstractAuthenticationProcessingFilter的扩展。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/** 默认的请求参数名称是username和password  */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">;</span>

    <span class="cm">/** 设置默认的参数名，这里可以通过setter方法设置这两个参数，对默认值进行覆盖 */</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">usernameParameter</span> <span class="o">=</span> <span class="n">SPRING_SECURITY_FORM_USERNAME_KEY</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">passwordParameter</span> <span class="o">=</span> <span class="n">SPRING_SECURITY_FORM_PASSWORD_KEY</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="nf">UsernamePasswordAuthenticationFilter</span><span class="o">()</span> <span class="o">{</span>
	    <span class="cm">/** 设置RequestMatcher，默认是 URL:/login, POST方法 */</span>
		<span class="kd">super</span><span class="o">(</span><span class="k">new</span> <span class="n">AntPathRequestMatcher</span><span class="o">(</span><span class="s">"/login"</span><span class="o">,</span> <span class="s">"POST"</span><span class="o">));</span>
	<span class="o">}</span>
	
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
			<span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
			<span class="cm">/** 校验是否是POST请求 */</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">postOnly</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"POST"</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">AuthenticationServiceException</span><span class="o">(</span>
					<span class="s">"Authentication method not supported: "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
		<span class="o">}</span>

        <span class="cm">/** 从请求中获取用户名和密码 */</span>
		<span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">obtainUsername</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">obtainPassword</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">username</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">username</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">password</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span>

        <span class="cm">/** 构造Authentication对象，用于身份认证 */</span>
		<span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span>
				<span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

		<span class="c1">// Allow subclasses to set the "details" property</span>
		<span class="n">setDetails</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">authRequest</span><span class="o">);</span>

        <span class="cm">/** 使用AuthenticationManager进行身份认证 */</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthenticationManager</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">authRequest</span><span class="o">);</span>
	<span class="o">}</span>	
</code></pre></div></div>
<p><code class="highlighter-rouge">UsernamePasswordAuthenticationFilter</code> 是基于用户密码的身份认证拦截器。它拦截POST请求/login路径的请求，从请求中提取用户名和密码(参数名称默认的是username和password)封装成UsernamePasswordAuthenticationToken对象，然后调用AuthenticationManager进行身份认证。</p>

<h3 id="7-defaultloginpagegeneratingfilter">7. DefaultLoginPageGeneratingFilter</h3>
<p>顾名思义，这个过滤器是用来生成默认的登录页面的。只有当没有配置登录的URL时，该过滤器才会插入到过滤链中。</p>

<h3 id="8-basicauthenticationfilter">8. BasicAuthenticationFilter</h3>
<p>该过滤器扩展自OncePerRequestFilter，所以它的核心功能代码只会执行一次。这个过滤器提供HTTP基本认证。</p>

<h3 id="9-requestcacheawarefilter">9. RequestCacheAwareFilter</h3>
<p>该过滤器用于恢复被打断的请求。它是用来处理这么一种场景：一个用户在未登录的情况下直接访问一个受保护的资源，系统会抛出AuthenticationException异常，ExceptionTranslationFilter捕获异常，并缓存该请求后，将该请求重定向到登录页，用户登录后需要恢复到原来要访问的URL，这个过滤器就是用来恢复之前的请求的。</p>

<h3 id="10-securitycontextholderawarerequestfilter">10. SecurityContextHolderAwareRequestFilter</h3>
<p>该过滤器用来包装请求，实现servlet api一些接口方法。</p>

<h3 id="11-anonymousauthenticationfilter">11. AnonymousAuthenticationFilter</h3>
<p>该过滤器检查SecurityContextHolder中是否有Authentication信息，如果没有则创建一个AnonymousAuthenticationToken</p>

<h3 id="12-sessionmanagementfilter">12. SessionManagementFilter</h3>
<p>检测从请求开始时，让用户是否通过身份认证，如果通过身份认证，则调用<code class="highlighter-rouge">SessionAuthenticationStrategy</code> 执行与会话相关的活动，例如：会话固化保护或者会话并发控制。Session这块儿，后面单独拿出来研究，这里不深入。</p>

<h3 id="13-exceptiontranslationfilter">13. ExceptionTranslationFilter</h3>
<p>该过滤器处理由<code class="highlighter-rouge">AbstractSecurityInterceptor</code>抛出的<code class="highlighter-rouge">AccessDeniedException</code>和<code class="highlighter-rouge">AuthenticationException</code>异常。该处理器虽然没有做任何安全相关的事情，但是它捕获拦截器抛出的异常，将异常转化为合适的HTTP响应，是连接java异常和HTTP响应的桥梁。该处理器如果捕获的是<code class="highlighter-rouge">AuthenticationException</code>异常，则调用<code class="highlighter-rouge">AuthenticationEntryPoint</code>接口处理这个身份认证失败异常，这里我们可以实现<code class="highlighter-rouge">AuthenticationEntryPoint</code>接口，来处理身份认证失败的情况。过滤器如果捕获的是<code class="highlighter-rouge">AccessDeniedException</code>异常，会先判断是否是匿名用户，如果是匿名用户则调用<code class="highlighter-rouge">AuthenticationEntryPoint</code>接口，要求用户进行身份认证。如果不是匿名用户，过滤器则委托<code class="highlighter-rouge">AccessDeniedHandler</code>处理该异常，默认是交给<code class="highlighter-rouge">AccessDeniedHandlerImpl</code>处理。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">req</span><span class="o">;</span>
		<span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">res</span><span class="o">;</span>

		<span class="k">try</span> <span class="o">{</span>
		    <span class="cm">/** 执行过滤链 */</span>
			<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Chain processed normally"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		    <span class="cm">/** 捕获过滤链抛出的异常 */</span>
			<span class="c1">// Try to extract a SpringSecurityException from the stacktrace</span>
			<span class="cm">/** 展开异常 */</span>
			<span class="n">Throwable</span><span class="o">[]</span> <span class="n">causeChain</span> <span class="o">=</span> <span class="n">throwableAnalyzer</span><span class="o">.</span><span class="na">determineCauseChain</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
			
			<span class="cm">/** 将异常转换成AuthenticationException异常，结果如果不为null，则说明抛出的是AuthenticationException异常 */</span>
			<span class="n">RuntimeException</span> <span class="n">ase</span> <span class="o">=</span> <span class="o">(</span><span class="n">AuthenticationException</span><span class="o">)</span> <span class="n">throwableAnalyzer</span>
					<span class="o">.</span><span class="na">getFirstThrowableOfType</span><span class="o">(</span><span class="n">AuthenticationException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">causeChain</span><span class="o">);</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">ase</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="cm">/** 说明ase不是AuthenticationException， 则再转换成AccessDeniedException异常，不为null则是AccessDeniedException */</span>
				<span class="n">ase</span> <span class="o">=</span> <span class="o">(</span><span class="n">AccessDeniedException</span><span class="o">)</span> <span class="n">throwableAnalyzer</span><span class="o">.</span><span class="na">getFirstThrowableOfType</span><span class="o">(</span>
						<span class="n">AccessDeniedException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">causeChain</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">ase</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			    <span class="cm">/** 如果是上面的两种异常，则处理异常 */</span>
				<span class="n">handleSpringSecurityException</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">chain</span><span class="o">,</span> <span class="n">ase</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
			    <span class="cm">/** 否则，抛出异常 */</span>
				<span class="c1">// Rethrow ServletExceptions and RuntimeExceptions as-is</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="n">ServletException</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="o">(</span><span class="n">ServletException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="n">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="o">(</span><span class="n">RuntimeException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>

				<span class="c1">// Wrap other Exceptions. This shouldn't actually happen</span>
				<span class="c1">// as we've already covered all the possibilities for doFilter</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleSpringSecurityException</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
			<span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">,</span> <span class="n">RuntimeException</span> <span class="n">exception</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">AuthenticationException</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
					<span class="s">"Authentication exception occurred; redirecting to authentication entry point"</span><span class="o">,</span>
					<span class="n">exception</span><span class="o">);</span>
            <span class="cm">/** 是AuthenticationException异常，要求进行身份认证 */</span>
			<span class="n">sendStartAuthentication</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">chain</span><span class="o">,</span>
					<span class="o">(</span><span class="n">AuthenticationException</span><span class="o">)</span> <span class="n">exception</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">AccessDeniedException</span><span class="o">)</span> <span class="o">{</span>
		    <span class="cm">/** AccessDeniedException异常，判断是否是匿名用户，是匿名用户，要求进行身份认证 */</span>
			<span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">authenticationTrustResolver</span><span class="o">.</span><span class="na">isAnonymous</span><span class="o">(</span><span class="n">authentication</span><span class="o">)</span> <span class="o">||</span> <span class="n">authenticationTrustResolver</span><span class="o">.</span><span class="na">isRememberMe</span><span class="o">(</span><span class="n">authentication</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
						<span class="s">"Access is denied (user is "</span> <span class="o">+</span> <span class="o">(</span><span class="n">authenticationTrustResolver</span><span class="o">.</span><span class="na">isAnonymous</span><span class="o">(</span><span class="n">authentication</span><span class="o">)</span> <span class="o">?</span> <span class="s">"anonymous"</span> <span class="o">:</span> <span class="s">"not fully authenticated"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"); redirecting to authentication entry point"</span><span class="o">,</span>
						<span class="n">exception</span><span class="o">);</span>

				<span class="n">sendStartAuthentication</span><span class="o">(</span>
						<span class="n">request</span><span class="o">,</span>
						<span class="n">response</span><span class="o">,</span>
						<span class="n">chain</span><span class="o">,</span>
						<span class="k">new</span> <span class="nf">InsufficientAuthenticationException</span><span class="o">(</span>
								<span class="s">"Full authentication is required to access this resource"</span><span class="o">));</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
			    <span class="cm">/** 不是匿名用户，委托给accessDeniedHandler处理 */</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
						<span class="s">"Access is denied (user is not anonymous); delegating to AccessDeniedHandler"</span><span class="o">,</span>
						<span class="n">exception</span><span class="o">);</span>

				<span class="n">accessDeniedHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span>
						<span class="o">(</span><span class="n">AccessDeniedException</span><span class="o">)</span> <span class="n">exception</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sendStartAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
			<span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">,</span>
			<span class="n">AuthenticationException</span> <span class="n">reason</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="c1">// SEC-112: Clear the SecurityContextHolder's Authentication, as the</span>
		<span class="c1">// existing Authentication is no longer considered valid</span>
		<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
		<span class="n">requestCache</span><span class="o">.</span><span class="na">saveRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Calling Authentication entry point."</span><span class="o">);</span>
		<span class="n">authenticationEntryPoint</span><span class="o">.</span><span class="na">commence</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<h3 id="14-filtersecurityinterceptor">14. FilterSecurityInterceptor</h3>
<p>这个过滤器是核心安全过滤器，它扩展自<code class="highlighter-rouge">AbstractSecurityInterceptor</code>，主要完成鉴权功能。</p>

<p><code class="highlighter-rouge">FilterSecurityInterceptor</code> 关键代码</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span>
			<span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">FilterInvocation</span> <span class="n">fi</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilterInvocation</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">chain</span><span class="o">);</span>
		<span class="n">invoke</span><span class="o">(</span><span class="n">fi</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">FilterInvocation</span> <span class="n">fi</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">FILTER_APPLIED</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">observeOncePerRequest</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// filter already applied to this request and user wants us to observe</span>
			<span class="c1">// once-per-request handling, so don't re-do security checking</span>
			<span class="n">fi</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">fi</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// first time this request being called, so perform security checking</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			    <span class="cm">/** 请求第一次被该类型的过滤器处理，设置标识，后续不再处理 */</span>
				<span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">FILTER_APPLIED</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
			<span class="o">}</span>

            <span class="cm">/** 前置处理，用来鉴权 */</span>
			<span class="n">InterceptorStatusToken</span> <span class="n">token</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">beforeInvocation</span><span class="o">(</span><span class="n">fi</span><span class="o">);</span>

			<span class="k">try</span> <span class="o">{</span>
			    <span class="cm">/** 过滤链  */</span>
				<span class="n">fi</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">fi</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">fi</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">finally</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">finallyInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
			<span class="o">}</span>

            <span class="cm">/** 后置 */</span>
			<span class="kd">super</span><span class="o">.</span><span class="na">afterInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">AbstractSecurityInterceptor</code> 关键代码</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">protected</span> <span class="n">InterceptorStatusToken</span> <span class="nf">beforeInvocation</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="s">"Object was null"</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">();</span>

		<span class="k">if</span> <span class="o">(!</span><span class="n">getSecureObjectClass</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
					<span class="s">"Security invocation attempted for object "</span>
							<span class="o">+</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
							<span class="o">+</span> <span class="s">" but AbstractSecurityInterceptor only configured to support secure objects of type: "</span>
							<span class="o">+</span> <span class="n">getSecureObjectClass</span><span class="o">());</span>
		<span class="o">}</span>

        <span class="cm">/** 获取元数据，这个数据会传递给访问决策器 */</span>
		<span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">obtainSecurityMetadataSource</span><span class="o">()</span>
				<span class="o">.</span><span class="na">getAttributes</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">attributes</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">rejectPublicInvocations</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
						<span class="s">"Secure object invocation "</span>
								<span class="o">+</span> <span class="n">object</span>
								<span class="o">+</span> <span class="s">" was denied as public invocations are not allowed via this interceptor. "</span>
								<span class="o">+</span> <span class="s">"This indicates a configuration error because the "</span>
								<span class="o">+</span> <span class="s">"rejectPublicInvocations property is set to 'true'"</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Public object - authentication not attempted"</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="n">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">PublicInvocationEvent</span><span class="o">(</span><span class="n">object</span><span class="o">));</span>

			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// no further work post-invocation</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Secure object: "</span> <span class="o">+</span> <span class="n">object</span> <span class="o">+</span> <span class="s">"; Attributes: "</span> <span class="o">+</span> <span class="n">attributes</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">credentialsNotFound</span><span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span>
					<span class="s">"AbstractSecurityInterceptor.authenticationNotFound"</span><span class="o">,</span>
					<span class="s">"An Authentication object was not found in the SecurityContext"</span><span class="o">),</span>
					<span class="n">object</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
		<span class="o">}</span>

        <span class="cm">/** 获取Authentication对象 */</span>
		<span class="n">Authentication</span> <span class="n">authenticated</span> <span class="o">=</span> <span class="n">authenticateIfRequired</span><span class="o">();</span>

		<span class="c1">// Attempt authorization</span>
		<span class="k">try</span> <span class="o">{</span>
		    <span class="cm">/** 鉴权，如果鉴权成功，则可以放过该请求 */</span>
			<span class="k">this</span><span class="o">.</span><span class="na">accessDecisionManager</span><span class="o">.</span><span class="na">decide</span><span class="o">(</span><span class="n">authenticated</span><span class="o">,</span> <span class="n">object</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="o">)</span> <span class="o">{</span>
		    <span class="cm">/** 鉴权失败 */</span>
			<span class="n">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">AuthorizationFailureEvent</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">authenticated</span><span class="o">,</span>
					<span class="n">accessDeniedException</span><span class="o">));</span>

			<span class="k">throw</span> <span class="n">accessDeniedException</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Authorization successful"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">publishAuthorizationSuccess</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">AuthorizedEvent</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">authenticated</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="c1">// Attempt to run as a different user</span>
		<span class="n">Authentication</span> <span class="n">runAs</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">runAsManager</span><span class="o">.</span><span class="na">buildRunAs</span><span class="o">(</span><span class="n">authenticated</span><span class="o">,</span> <span class="n">object</span><span class="o">,</span>
				<span class="n">attributes</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">runAs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"RunAsManager did not change Authentication object"</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="c1">// no further work post-invocation</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InterceptorStatusToken</span><span class="o">(</span><span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span>
					<span class="n">attributes</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Switching to RunAs Authentication: "</span> <span class="o">+</span> <span class="n">runAs</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="n">SecurityContext</span> <span class="n">origCtx</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
			<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">createEmptyContext</span><span class="o">());</span>
			<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">runAs</span><span class="o">);</span>

			<span class="c1">// need to revert to token.Authenticated post-invocation</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InterceptorStatusToken</span><span class="o">(</span><span class="n">origCtx</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">protected</span> <span class="n">Object</span> <span class="nf">afterInvocation</span><span class="o">(</span><span class="n">InterceptorStatusToken</span> <span class="n">token</span><span class="o">,</span> <span class="n">Object</span> <span class="n">returnedObject</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// public object</span>
			<span class="k">return</span> <span class="n">returnedObject</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">finallyInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// continue to clean in this method for passivity</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">afterInvocationManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Attempt after invocation handling</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">returnedObject</span> <span class="o">=</span> <span class="n">afterInvocationManager</span><span class="o">.</span><span class="na">decide</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getSecurityContext</span><span class="o">()</span>
						<span class="o">.</span><span class="na">getAuthentication</span><span class="o">(),</span> <span class="n">token</span><span class="o">.</span><span class="na">getSecureObject</span><span class="o">(),</span> <span class="n">token</span>
						<span class="o">.</span><span class="na">getAttributes</span><span class="o">(),</span> <span class="n">returnedObject</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="n">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">AuthorizationFailureEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthorizationFailureEvent</span><span class="o">(</span>
						<span class="n">token</span><span class="o">.</span><span class="na">getSecureObject</span><span class="o">(),</span> <span class="n">token</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">(),</span> <span class="n">token</span>
								<span class="o">.</span><span class="na">getSecurityContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">(),</span>
						<span class="n">accessDeniedException</span><span class="o">);</span>
				<span class="n">publishEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>

				<span class="k">throw</span> <span class="n">accessDeniedException</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">returnedObject</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finallyInvocation</span><span class="o">(</span><span class="n">InterceptorStatusToken</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">isContextHolderRefreshRequired</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Reverting to original Authentication: "</span>
						<span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="na">getSecurityContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">());</span>
			<span class="o">}</span>

			<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getSecurityContext</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>这里只是过一遍整个过滤链，介绍每个过滤器的功能，具体如何使用Spring Security框架，我们后续在说。我后面会重点分析<code class="highlighter-rouge">AuthenticationManager</code>和<code class="highlighter-rouge">AccessDecisionManager</code>这个两个和我们框架使用者相关的代码，并给出一个示例。</p>

<p>项目代码: <a href="https://github.com/manongcoding/springSecurityExplore">springSecurityExplore</a></p>


  </div>

  
</article>


      <footer class="site-footer">
        <!-- SVG icons from https://iconmonstr.com -->

        <!-- Github icon -->
        <span class="my-span-icon">
          <a href="https://github.com/jylaxp" aria-label="jylaxp's GitHub" title="jylaxp's GitHub">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
        </span>

        <!-- Twitter icon
        <span class="my-span-icon">
          <a href="https://twitter.com/" aria-label="jylaxp's Twitter" title="jylaxp's Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>
 -->
        <!-- RSS icon -->
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact jylaxp">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        

      </footer>
    </section>

    
  </body>
</html>
